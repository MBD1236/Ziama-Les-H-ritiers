{% extends "admin/base.html.twig" %}
{% block title %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box">
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="javascript: void(0);"><i class="ri-home-4-line me-1"></i>Accueil</a></li>
                    <li class="breadcrumb-item"><a href="{{ path('app_admin_client_index') }}">Clients</a></li>
                    <li class="breadcrumb-item active">Historique</li>
                </ol>
            </div>
            <h4 class="page-title">Historique d'achats — {{ client.nom }}</h4>
        </div>
    </div>
</div>
{% endblock title %}

{% block body %}

{% include "admin/partials/_flash.html.twig" %}

{# INFOS CLIENT #}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h5 class="mb-1"><i class="ri-user-line me-2"></i>{{ client.nom }}</h5>
                        <p class="mb-0 text-muted">
                            <i class="ri-phone-line me-1"></i>{{ client.telephone }}
                            &nbsp;|&nbsp;
                            <i class="ri-map-pin-line me-1"></i>{{ client.adresse }}
                            &nbsp;|&nbsp;
                            <span class="badge bg-info">{{ client.typeClient }}</span>
                        </p>
                    </div>
                    <a href="{{ path('app_admin_client_index') }}" class="btn btn-secondary btn-sm">
                        <i class="ri-arrow-left-line me-1"></i>Retour
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{# KPI #}
<div class="row">
    <div class="col-sm-6 col-xxl-3">
        <div class="card widget-flat text-bg-info">
            <div class="card-body">
                <div class="float-end">
                    <i class="ri-shopping-basket-line widget-icon"></i>
                </div>
                <h6 class="text-uppercase mt-0">Total commandes</h6>
                <h2 class="my-2">{{ nombreVentes }}</h2>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xxl-3">
        <div class="card widget-flat text-bg-purple">
            <div class="card-body">
                <div class="float-end">
                    <i class="ri-money-dollar-circle-line widget-icon"></i>
                </div>
                <h6 class="text-uppercase mt-0">Montant total dépensé</h6>
                <h2 class="my-2">{{ montantTotal|number_format(0, '.', ' ') }} GNF</h2>
            </div>
        </div>
    </div>
</div>


{# TABLEAU DES VENTES #}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-history-line me-2"></i>
                    Historique des ventes
                    {% if dateDebut or dateFin %}
                        <small class="text-muted">
                            ({{ dateDebut ?: '...' }} → {{ dateFin ?: '...' }})
                        </small>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Code vente</th>
                            <th>Date</th>
                            <th>Produits</th>
                            <th>Montant total</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for k, vente in ventes %}
                        <tr>
                            <td>{{ k + 1 }}</td>
                            <td><strong>{{ vente.codeVente }}</strong></td>
                            <td>{{ vente.dateVente|date('d/m/Y H:i') }}</td>
                            <td>
                                {% for ligne in vente.lignes %}
                                    <span class="badge bg-light text-dark border">
                                        {{ ligne.produit.nom }} x{{ ligne.quantite }}
                                    </span>
                                {% endfor %}
                            </td>
                            <td>
                                <strong>{{ vente.montantTotal|number_format(0, '.', ' ') }} GNF</strong>
                            </td>
                            <td>
                                {% if vente.statut == 'Livré' %}
                                    <span class="badge bg-success">{{ vente.statut }}</span>
                                {% elseif vente.statut == 'En cours' %}
                                    <span class="badge bg-warning text-dark">{{ vente.statut }}</span>
                                {% elseif vente.statut == 'Annulé' %}
                                    <span class="badge bg-danger">{{ vente.statut }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ vente.statut }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ path('app_admin_vente_show', {'id': vente.id}) }}"
                                   class="btn btn-info btn-sm">
                                    <i class="ri-eye-line"></i>
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="ri-inbox-line" style="font-size:2rem"></i>
                                <p class="mt-2">Aucune vente trouvée pour ce client.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if ventes|length > 0 %}
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Total :</td>
                            <td colspan="3" class="fw-bold text-primary">
                                {{ montantTotal|number_format(0, '.', ' ') }} GNF
                            </td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock body %}